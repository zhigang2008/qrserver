/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/layers/ServiceGeneratedFeatureCollection",["dojo/_base/declare","dojo/_base/connect","dojo/_base/lang","dojo/_base/array","dojo/dom-construct","dojo/dom-style","dojo/has","esri/kernel","esri/SpatialReference","esri/geometry/Extent","esri/geometry/webMercatorUtils","esri/renderers/SimpleRenderer","esri/layers/layer","esri/layers/FeatureLayer","esri/dijit/PopupTemplate"],function(_1,_2,_3,_4,_5,_6,_7,_8,_9,_a,_b,_c,_d,_e,_f){var _10=_1([_d],{declaredClass:"esri.layers._ServiceGeneratedFeatureCollection",constructor:function(url,_11){this.pointSymbol=_11&&_11.pointSymbol;this.polylineSymbol=_11&&_11.polylineSymbol;this.polygonSymbol=_11&&_11.polygonSymbol;this._outSR=(_11&&(_11.outSpatialReference||_11.outSR))||new _9({wkid:4326});this._options=_11;this.registerConnectEvents("esri.layers._ServiceGeneratedFeatureCollection",true);},parse:function(){console.error("parse function has not been implemented");},getFeatureLayers:function(){var _12=[];if(this._fLayers){_12=_12.concat(this._fLayers);}return _12;},onRefresh:function(){},refresh:function(){if(!this.loaded||!this._map||this._io){return;}this._createLayer();},_createLayer:function(_13){var _14=this;this._fireUpdateStart();var _15=this.parse(_13);_15.addCallback(function(_16){_14._io=null;_14._initLayer(_16);});_15.addErrback(function(err){_14._io=null;err=_3.mixin(new Error(),err);err.message="Unable to load resource: "+_14.url+" "+(err.message||"");_14._fireUpdateEnd(err);_14.onError(err);});},_initLayer:function(_17){if(this.loaded){this._removeInternalLayers();}this.name=_17.name;this.description=_17.description;this.snippet=_17.snippet;if(_17.visibility!==undefined){this.defaultVisibility=this.visible=!!_17.visibility;}else{this.defaultVisibility=this.visible=true;}this.featureInfos=_17.featureInfos;this.fullExtent=this.initialExtent=new _a(_17.lookAtExtent);this.copyright=_17.author||_17.copyright;var _18;var _19=_3.getObject("featureCollection.layers",false,_17);if(_19&&_19.length>0){this._fLayers=[];_4.forEach(_19,function(_1a,i){var _1b=_3.getObject("featureSet.features",false,_1a),_1c;if(_1b&&_1b.length>0){_18=_3.mixin({outFields:["*"],infoTemplate:_1a.popupInfo?new _f(_1a.popupInfo):null,editable:false},this._options);if(_18.id){_18.id=_18.id+"_"+i;}_1a.layerDefinition.capabilities="Query,Data";_1c=new _e(_1a,_18);if(_1c.geometryType){this["_"+_1c.geometryType]=_1c;}this._fLayers.push(_1c);}},this);if(this._fLayers.length===0){delete this._fLayers;}}this.items=[];if(this._esriGeometryPoint){this.items=this.items.concat(this._esriGeometryPoint.graphics);if(this.pointSymbol){var _1d=new _c(this.pointSymbol);this._esriGeometryPoint.setRenderer(_1d);}}if(this._esriGeometryPolyline){this.items=this.items.concat(this._esriGeometryPolyline.graphics);if(this.polylineSymbol){var _1e=new _c(this.polylineSymbol);this._esriGeometryPolyline.setRenderer(_1e);}}if(this._esriGeometryPolygon){this.items=this.items.concat(this._esriGeometryPolygon.graphics);if(this.polygonSymbol){var _1f=new _c(this.polygonSymbol);this._esriGeometryPolygon.setRenderer(_1f);}}this._fireUpdateEnd();if(this.loaded){this._addInternalLayers();this.onRefresh();}},_addInternalLayers:function(){var map=this._map;this._fireUpdateStart();var _20=map.spatialReference,_21=this._outSR,_22;if(_20.wkid){_22=(_20._isWebMercator()&&_21._isWebMercator())||(_20.wkid===_21.wkid);}else{if(_20.wkt){_22=(_20.wkt===_21.wkt);}else{console.log("_setMap - map has invalid spatial reference");return;}}if(!_22){if(_20._isWebMercator()&&_21.wkid===4326){this._converter=_b.geographicToWebMercator;}else{if(_21._isWebMercator()&&_20.wkid===4326){this._converter=_b.webMercatorToGeographic;}else{console.log("_setMap - unsupported workflow. Spatial reference of the map and layer do not match, and the conversion cannot be done on the client.");return;}}}var _23=this._fLayers;if(_23&&_23.length>0){_4.forEach(_23,function(_24){if(this._converter){var _25=_24.graphics,i,_26,len=_25?_25.length:0;for(i=0;i<len;i++){_26=_25[i].geometry;if(_26){_25[i].setGeometry(this._converter(_26));}}}map.addLayer(_24);},this);}this.setVisibility(this.visible);},_removeInternalLayers:function(){var map=this._map;if(map){_4.forEach(this.getFeatureLayers(),map.removeLayer,map);}},onVisibilityChange:function(_27){this._fireUpdateStart();_4.forEach(this.getFeatureLayers(),function(_28){_28.setVisibility(_27);});this._fireUpdateEnd();},_setMap:function(map,_29){this.inherited(arguments);this._map=map;var div=this._div=_5.create("div",null,_29);_6.set(div,"position","absolute");this._addInternalLayers();this.evaluateSuspension();return div;},_unsetMap:function(map,_2a){if(this._io){this._io.cancel();}_2.disconnect(this._extChgHandle);delete this._extChgHandle;this._removeInternalLayers();var div=this._div;if(div){_2a.removeChild(div);_5.destroy(div);}this._div=null;this.inherited(arguments);}});if(_7("extend-esri")){_3.setObject("layers._ServiceGeneratedFeatureCollection",_10,_8);}return _10;});